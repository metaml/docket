#!/bin/bash

# @todo: generalize using env vars
c=$(dig +short deck-zookeeper.marathon.mesos | wc -l)
while [ $c -lt 3 ]; do
    sleep 1
    c=$(dig +short deck-zookeeper.marathon.mesos | wc -l)
done

ZOO_CFG=/opt/zookeeper/conf/zoo.cfg
echo "# autogenerated by zookeeper's 'start' script" >> $ZOO_CFG

myid=0
ZKIPS=$(dig +short deck-zookeeper.marathon.mesos | sort)
for ip in $ZKIPS; do
    myid=$((myid+1))
    echo "server.$myid=$ip:2888:3888" >> $ZOO_CFG
    echo $myid > /data/myid
done

bash -x /opt/zookeeper/bin/zkServer.sh start-foreground
